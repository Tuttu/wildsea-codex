{{/* This partial receives a context '.' containing:
- .data: The unmarshaled hexjson data
- .mapID: The unique ID of the map (e.g., "hexmap-0")
*/}}

{{/* --- 1. Find all unique region names --- */}}
{{ $regions := slice }}
{{ range .data.hexes }}
    {{ with .region }}
        {{ $regions = $regions | append . | uniq }}
    {{ end }}
{{ end }}
{{ $regions = $regions | sort }}

{{/* --- 2. Find all "Unknown" hexes --- */}}
{{ $unknownHexes := slice }}
{{ range $hexID, $hexData := .data.hexes }}
    {{ if and (not $hexData.region) (ne $hexData.anchor true) }}
        {{ $unknownHexes = $unknownHexes | append (dict "id" $hexID "data" $hexData) }}
    {{ end }}
{{ end }}


{{/* --- 3. Build the Legend HTML --- */}}
<div class="legend-container">
    <input type="text" class="legend-filter" placeholder="Filter locations...">

    {{/* --- 4. Loop over each known region and create a section --- */}}
    {{ range $regions }}
        {{ $currentRegion := . }}

        {{/* --- NEW: Calculate Cartography Stats --- */}}
        {{ $total := 0 }}
        {{ $carto := 0 }}
        {{/* Get the threshold from the new .data.regions object, default to 9999 */}}
        {{ $threshold := index $.data.regions $currentRegion "carto_threshold" | default 9999 }}

        {{/* Loop all hexes to find stats for this region */}}
        {{ range $hexID, $hexData := $.data.hexes }}
            {{ if and (eq $hexData.region $currentRegion) (ne $hexData.anchor true) }}
                {{ $total = add $total 1 }}
                {{/* Check if "c" property is true */}}
                {{ if $hexData.c }}
                    {{ $carto = add $carto 1 }}
                {{ end }}
            {{ end }}
        {{ end }}

        {{/* Determine class and tooltip */}}
        {{ $isCarto := ge $carto $threshold }}
        {{ $cartoClass := "icon-non-cartographized" }}
        {{ if $isCarto }}
            {{ $cartoClass = "cartographized" }}
        {{ end }}
        {{ $tooltip := printf "%d/%d hexes cartographized" $carto $total }}
        {{/* --- END NEW LOGIC --- */}}
        
        <div class="legend-section">
            {{/* --- MODIFIED H2 --- */}}
            <h2 class="collapsible-header" data-region-id="{{ $currentRegion }}">
                {{/* Use üó∫Ô∏è for cartography, as it matches your existing classes */}}
                {{/*  <span class="{{ $cartoClass }}" title="{{ $tooltip }}">üó∫Ô∏è</span>  */}}
                {{ $currentRegion }}
            </h2>

            <div class="collapsible-content">
                <ul class="hexmap-legend poi-legend">
                    
                    {{/* Find all hexes that match this region */}}
                    {{ range $hexID, $hexData := $.data.hexes }}
                        {{ if and (eq $hexData.region $currentRegion) (ne $hexData.anchor true) }}
                            <li data-hex-id="{{ $hexID }}">
                                {{ $explored := $hexData.e | default false }}
                                {{ $cartographed := $hexData.c | default false }}
                                
                                <span class="{{ if $explored }}explored{{ else }}icon-non-explored{{ end }}">üîé</span>
                                <span class="{{ if $cartographed }}cartographized{{ else }}icon-non-cartographized{{ end }}">üó∫Ô∏è</span>
                                
                                {{ $hexData.n | default $hexID }}
                            </li>
                        {{ end }}
                    {{ end }}
                </ul>
            </div>
        </div>
    {{ end }}

    {{/* --- 5. Create the "Unknown Region" section (if any) --- */}}
    {{ if gt (len $unknownHexes) 0 }}
        <div class="legend-section">
            {{/* "Unknown Region" doesn't get a status icon */}}
            <h2 class="collapsible-header">Unknown Region</h2>
            <div class="collapsible-content">
                <ul class="hexmap-legend poi-legend">
                    {{ range $unknownHexes }}
                        <li data-hex-id="{{ .id }}">
                            {{ $explored := .data.e | default false }}
                            {{ $cartographed := .data.c | default false }}
                            
                            <span class="{{ if $explored }}explored{{ else }}icon-non-explored{{ end }}">üîé</span>
                            <span class="{{ if $cartographed }}cartographized{{ else }}icon-non-cartographized{{ end }}">üó∫Ô∏è</span>
                            
                            {{ .data.n | default .id }}
                        </li>
                    {{ end }}
                </ul>
            </div>
        </div>
    {{ end }}
</div>